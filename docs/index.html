<script>
  // Mapbox access
  mapboxgl.accessToken = 'pk.eyJ1IjoiYW5uYWdheWxvcmQiLCJhIjoiY21kN3NpZ2JkMG4zZDJpcG5pbWg4aW11YiJ9.HdgP-3PazrYIUhRAmc-b5w';

  // Initialize map
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-98, 38],
    zoom: 3
  });

  // Globals
  let dates = [];
  let casesLookup = {};
  let stateData = null;
  const norm = s => String(s ?? '').trim().toUpperCase();

  // Wrap PapaParse in a Promise to load CSV rows
  function loadCases() {
    return new Promise(resolve => {
      Papa.parse('data/USMeaslesCases.csv', {
        download: true,
        header: true,
        complete: ({ data }) => {
          const rows = data.filter(r => r.date);
          resolve(rows);
        }
      });
    });
  }

  // Fetch GeoJSON
  async function loadStateGeoJSON() {
    const res = await fetch('data/us_states.geojson');
    if (!res.ok) throw new Error(`GeoJSON load failed: ${res.status}`);
    return await res.json();
  }

  // Add the fill layer (uses coalesce to guard nulls)
  function addStateLayer() {
    map.addSource('states', { type: 'geojson', data: stateData });
    map.addLayer({
      id: 'state-fills',
      type: 'fill',
      source: 'states',
      paint: {
        'fill-color': [
          'interpolate', ['linear'],
          ['coalesce', ['get','cases'], 0],
          0,  '#ffffff',
          1,  '#fee5d9',
          5,  '#fcae91',
          10, '#fb6a4a',
          20, '#de2d26',
          50, '#a50f15'
        ],
        'fill-opacity': 0.7
      }
    });
    // optional outline for visibility
    map.addLayer({
      id: 'state-outline',
      type: 'line',
      source: 'states',
      paint: { 'line-color': '#666', 'line-width': 0.8 }
    });
  }

  // Assign .cases for a given date and refresh the source
  function updateMap(date) {
    stateData.features.forEach(f => {
      const key = `${norm(f.properties.ste_name)}_${date}`;
      f.properties.cases = casesLookup[key] || 0;
    });
    map.getSource('states').setData(stateData);
  }

  // Slider wiring
  function initSlider() {
    const slider = document.getElementById('dateSlider');
    const label  = document.getElementById('dateLabel');
    slider.min   = 0;
    slider.max   = dates.length - 1;
    slider.oninput = e => {
      const d = dates[e.target.value];
      label.textContent = d;
      updateMap(d);
    };
  }

  // Boot sequence
  map.on('load', async () => {
    // 1) Load both CSV rows and GeoJSON in parallel
    const [rows, geo] = await Promise.all([loadCases(), loadStateGeoJSON()]);
    stateData = geo;

    // 2) Build dates array and lookup
    dates = Array.from(new Set(rows.map(r => r.date))).sort();
    rows.forEach(r => {
      const key = `${norm(r.state)}_${r.date}`;
      casesLookup[key] = Number(r.cases) || 0;
    });

    // 3) Find a date that has some >0 values
    const firstWithData = dates.find(d =>
      stateData.features.some(f =>
        (casesLookup[`${norm(f.properties.ste_name)}_${d}`] || 0) > 0
      )
    ) || dates[0];
    console.log('Drawing first data date:', firstWithData);

    // 4) Prime .cases for that date BEFORE adding the layer
    stateData.features.forEach(f => {
      const key = `${norm(f.properties.ste_name)}_${firstWithData}`;
      f.properties.cases = casesLookup[key] || 0;
    });

    // 5) Now add the layer and slider
    addStateLayer();
    initSlider();

    // 6) Draw for that date & sync slider UI
    updateMap(firstWithData);
    const idx = dates.indexOf(firstWithData);
    document.getElementById('dateSlider').value      = idx;
    document.getElementById('dateLabel').textContent = firstWithData;

    // — optional deep debug —
    const stats = stateData.features.reduce((acc,f) => {
      const v = f.properties.cases;
      acc.total++;
      if (typeof v === 'number') acc.num++;
      if (v > 0) acc.pos++;
      return acc;
    }, { total:0, num:0, pos:0 });
    console.log('cases stats:', stats);
  });
</script>
