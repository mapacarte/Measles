<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>US Measles Time Series</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>

  <!-- PapaParse CSV parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    /* Title bar */
    #title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.85);
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 18px;
      font-weight: bold;
      z-index: 3;
    }

    /* Layer toggle buttons */
    #layer-toggle {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.85);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 3;
    }
    #layer-toggle button {
      margin: 0 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    /* Slider container */
    #slider-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.8);
      padding: 6px 12px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 2;
    }
    #slider { flex: 1; }
    #date-label {
      min-width: 60px;
      text-align: center;
      font-weight: bold;
    }

    /* Legend */
    #legend {
      position: absolute;
      bottom: 100px;
      left: 10px;
      background: white;
      padding: 8px;
      font-size: 12px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      z-index: 2;
    }
    .legend-item { margin-bottom: 4px; display: flex; align-items: center; }
    .legend-key { width: 16px; height: 16px; margin-right: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<div id="title">Monthly Measles Cases</div>
<div id="layer-toggle"></div>
<div id="map"></div>

<div id="slider-container">
  <input id="slider" type="range" min="0" max="0" />
  <span id="date-label"></span>
  <button id="playPause">Pause</button>
</div>

<div id="legend"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYW5uYWdheWxvcmQiLCJhIjoiY21kN3NpZ2JkMG4zZDJpcG5pbWg4aW11YiJ9.HdgP-3PazrYIUhRAmc-b5w';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v10',
  center: [-98, 38],
  zoom: 3
});
map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

// — Globals —
let months = [], casesLookup = {}, countyByMonth = {};
let stateData, countyData, currentMonthKey;

function norm(str) { return String(str||'').trim().toUpperCase(); }

// — Load & Aggregate Cases —
async function loadCases() {
  return new Promise((res, rej) => Papa.parse('data/USMeaslesCases.csv', {
    download:true, header:true,
    complete: ({data}) => {
      data.forEach(r => {
        if (!r.date) return;
        const m = r.date.slice(0,7);
        if (!months.includes(m)) months.push(m);
        const key = `${norm(r.state)}_${m}`;
        casesLookup[key] = (casesLookup[key]||0) + (+r.cases);
        countyByMonth[m] = countyByMonth[m]||{};
        countyByMonth[m][r.location_id] = (countyByMonth[m][r.location_id]||0) + (+r.cases);
      });
      months.sort(); res();
    }, error: rej
  }));
}

// — Load GeoJSON —
async function loadGeoJSON() {
  [stateData, countyData] = await Promise.all([
    fetch('data/us_states.geojson').then(r=>r.json()),
    fetch('data/counties.geojson').then(r=>r.json())
  ]);
}

// — Popups —
function showStatePopup(e) {
  const p = e.features[0].properties;
  new mapboxgl.Popup().setLngLat(e.lngLat)
    .setHTML(`<strong>${p.NAME}</strong><br>${p.cases||0} cases`)
    .addTo(map);
}
function showCountyPopup(e) {
  const f = e.features[0];
  const p = f.properties;
  const c = f.state?.cases||p.cases||0;
  new mapboxgl.Popup().setLngLat(e.lngLat)
    .setHTML(`<strong>${p.NAME}, ${p.STATE_NAME}</strong><br>${c} cases`)
    .addTo(map);
}

// — Update Layers —
function updateState(month) {
  stateData.features.forEach(f => {
    const key = `${norm(f.properties.STATE_NAME)}_${month}`;
    f.properties.cases = casesLookup[key]||0;
  });
  map.getSource('states').setData(stateData);
}
function updateCounty(month) {
  map.querySourceFeatures('counties').forEach(f =>
    map.setFeatureState({source:'counties',id:f.id},{cases:0})
  );
  Object.entries(countyByMonth[month]||{}).forEach(([id,c]) =>
    map.setFeatureState({source:'counties',id},{cases:c})
  );
}
function updateAll(month) {
  updateState(month);
  updateCounty(month);
}

// — UI Controls —
function addToggle() {
  const div = document.getElementById('layer-toggle');
  div.innerHTML = '<button id="btnStates">States</button><button id="btnCounties">Counties</button>';
  document.getElementById('btnStates').onclick = () => {
    map.setLayoutProperty('state-fills','visibility','visible');
    map.setLayoutProperty('state-outline','visibility','visible');
    map.setLayoutProperty('county-fills','visibility','none');
    map.setLayoutProperty('county-outline','visibility','none');
  };
  document.getElementById('btnCounties').onclick = () => {
    map.setLayoutProperty('state-fills','visibility','none');
    map.setLayoutProperty('state-outline','visibility','none');
    map.setLayoutProperty('county-fills','visibility','visible');
    map.setLayoutProperty('county-outline','visibility','visible');
  };
}

function initSlider() {
  const s = document.getElementById('slider'), lbl = document.getElementById('date-label');
  s.min=0; s.max=months.length-1; s.value=0;
  months.forEach((m,i)=> {
    const opt = document.createElement('option'); opt.value=i; opt.label=m;
    document.getElementById('slider').appendChild(opt);
  });
  s.oninput = () => {
    const m = months[+s.value]; lbl.textContent=m;
    updateAll(m);
  };
}

function buildLegend() {
  const breaks=[0,5,20,50,100], cols=['#f7fbff','#deebf7','#9ecae1','#3182bd','#08519c'];
  const lg = document.getElementById('legend'); lg.innerHTML='<strong>Cases</strong><br>';
  breaks.forEach((b,i)=>{
    const end = i<breaks.length-1?breaks[i+1]-1:'+';
    const row=document.createElement('div'); row.className='legend-item';
    row.innerHTML = `<span class='legend-key' style='background:${cols[i]}'></span> ${b}${end}`;
    lg.appendChild(row);
  });
}

map.on('load', async () => {
  await loadCases(); await loadGeoJSON();
  map.addSource('states',{type:'geojson',data:stateData});
  map.addLayer({id:'state-fills',type:'fill',source:'states',paint:{
    'fill-color':['interpolate',['linear'],['get','cases'],0,'#f7fbff',5,'#deebf7',20,'#9ecae1',50,'#3182bd',100,'#08519c'],
    'fill-opacity':0.7
  }});
  map.addLayer({id:'state-outline',type:'line',source:'states',paint:{'line-color':'#fff','line-width':0.5}});
  map.addSource('counties',{type:'geojson',data:countyData,promoteId:'GEOID'});
  map.addLayer({id:'county-fills',type:'fill',source:'counties',layout:{visibility:'none'},paint:{
    'fill-color':['interpolate',['linear'],['coalesce',['feature-state','cases'],0],0,'#f7fbff',5,'#deebf7',20,'#9ecae1',50,'#3182bd',100,'#08519c'],
    'fill-opacity':0.7
  }});
  map.addLayer({id:'county-outline',type:'line',source:'counties',layout:{visibility:'none'},paint:{'line-color':'#fff','line-width':0.5}});
  map.on('click','state-fills',showStatePopup);
  map.on('click','county-fills',showCountyPopup);
  addToggle(); initSlider(); buildLegend();
  document.getElementById('date-label').textContent = months[0];
  currentMonthKey = months[0]; updateAll(currentMonthKey);
});
</script>

</body>
</html>
