<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>US Measles Time Series (States Only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox GL JS -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>

  <!-- PapaParse CSV parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 50px; width: 100%; }
    #slider {
      position: absolute;
      bottom: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.8);
      padding: 5px 10px; border-radius: 3px;
    }
    #dateLabel { margin-left: 10px; font-weight: bold; }
	
  .legend {
    position: absolute;
    bottom: 60px;
    left: 10px;
    background: white;
    padding: 8px;
    font-family: sans-serif;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
  }
  
  .legend-key {
    display: inline-block;
    width: 20px;
    height: 20px;
    margin-right: 4px;
    vertical-align: middle;
  }
  .legend-item {
    margin-bottom: 4px;
    line-height: 20px;
  }
  
  input[type="range"]::-webkit-slider-runnable-track {
  height: 4px;
}
input[type="range"]::-webkit-slider-thumb {
  width: 12px; height: 12px; margin-top: -4px;
}
input[type="range"]::-moz-range-track {
  height: 4px;
}
input[type="range"]::-moz-range-thumb {
  width: 12px; height: 12px;
}

  </style>
</head>
<body>

<div id="map"></div>
<div id="slider" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.8);padding:5px 10px;border-radius:3px;display:flex;align-items:center;gap:8px;">
  <!-- range input will pick up ticks from this datalist -->
  <input 
    id="dateSlider" 
    type="range" 
    min="0" 
    max="0" 
    list="monthTicks" 
    style="flex:1;" />
  <datalist id="monthTicks"></datalist>
  
  <!-- show the current month -->
  <span id="dateLabel" style="min-width:60px;text-align:center;font-weight:bold;"></span>

  <!-- play/pause control -->
  <button id="playPause">Pause</button>

</div>

<div id="legend" class="legend"></div>
<script>
  // Mapbox access
  mapboxgl.accessToken = 'pk.eyJ1IjoiYW5uYWdheWxvcmQiLCJhIjoiY21kN3NpZ2JkMG4zZDJpcG5pbWg4aW11YiJ9.HdgP-3PazrYIUhRAmc-b5w';

  // Initialize map
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-98, 38],
    zoom: 3
  });

  // Globals
  let months = [];
  let casesLookup = {};
  let stateData = null;
  const norm = s => String(s ?? '').trim().toUpperCase();

  // 1) Load CSV, aggregate to months
  function loadCases() {
    return new Promise(resolve => {
      Papa.parse('data/USMeaslesCases.csv', {
        download: true,
        header: true,
        complete: ({ data }) => {
          const agg = {};
          data
            .filter(r => r.date)
            .forEach(r => {
              const month = r.date.slice(0,7); // "YYYY-MM"
              const key = `${norm(r.state)}_${month}`;
              agg[key] = (agg[key] || 0) + Number(r.cases);
            });
          casesLookup = agg;
          months = Array.from(
            new Set(data.filter(r=>r.date).map(r=>r.date.slice(0,7)))
          ).sort();
          resolve();
        }
      });
    });
  }

  // 2) Fetch GeoJSON
  async function loadStateGeoJSON() {
    const res = await fetch('data/us_states.geojson');
    if (!res.ok) throw new Error(`GeoJSON load failed: ${res.status}`);
    stateData = await res.json();
  }

  // 3) Add fill + outline layers
  function addStateLayer() {
    map.addSource('states', { type: 'geojson', data: stateData });
    map.addLayer({
      id: 'state-fills',
      type: 'fill',
      source: 'states',
      paint: {
        'fill-color': [
          'interpolate', ['linear'],
          ['coalesce', ['get','cases'], 0],
          0,  '#ffffff',
          1,  '#deebf7',
          50, '#9ecae1',
          100,'#6baed6',
          500,'#08519c'
        ],
        'fill-opacity': 0.8
      }
    });
    map.addLayer({
      id: 'state-outline',
      type: 'line',
      source: 'states',
      paint: { 'line-color': '#666', 'line-width': 0.8 }
    });
  }

  // 4) Update features for a given month
  function updateMap(month) {
    stateData.features.forEach(f => {
      const key = `${norm(f.properties.ste_name)}_${month}`;
      f.properties.cases = casesLookup[key] || 0;
    });
    map.getSource('states').setData(stateData);
  }

  // 5) Slider wiring
  function initSlider() {
    const slider = document.getElementById('dateSlider');
    const label  = document.getElementById('dateLabel');
    slider.min   = 0;
    slider.max   = months.length - 1;
    slider.oninput = e => {
      const idx = Number(e.target.value);
      const m   = months[idx];
      document.getElementById('dateLabel').textContent = m;
      updateMap(m);
    };
  }

  // 6) Build legend
  function addLegend() {
    const legend = document.getElementById('legend');
    const breaks = ['0', '1–49', '50–99', '100–499', '500+'];
    const colors = ['#ffffff', '#deebf7', '#9ecae1', '#6baed6', '#08519c'];
    breaks.forEach((b,i) => {
      const item = document.createElement('div');
      item.className = 'legend-item';
      const key = document.createElement('span');
      key.className = 'legend-key';
      key.style.backgroundColor = colors[i];
      item.appendChild(key);
      item.appendChild(document.createTextNode(b));
      legend.appendChild(item);
    });
  }

  // 7) Boot
  map.on('load', async () => {
    // load data
    await Promise.all([loadCases(), loadStateGeoJSON()]);

    // prime for the very first month
    const firstMonth = months[0];
    stateData.features.forEach(f => {
      const k = `${norm(f.properties.ste_name)}_${firstMonth}`;
      f.properties.cases = casesLookup[k] || 0;
    });
	
	// A) grab references
const slider      = document.getElementById('dateSlider');
const label       = document.getElementById('dateLabel');
const playPauseBtn = document.getElementById('playPause');

// B) autoplay state
let isPlaying  = true;
const pace     = 2000;            // ms between steps
let intervalId = null;

// C) step function
function stepForward() {
  let idx = Number(slider.value);
  idx = (idx + 1) % months.length;
  slider.value = idx;
  const m = months[idx];
  label.textContent = m;
  updateMap(m);
}

// D) start the interval
intervalId = setInterval(stepForward, pace);

// E) wire up the click
playPauseBtn.addEventListener('click', () => {
  if (isPlaying) {
    clearInterval(intervalId);
    playPauseBtn.textContent = 'Play';
  } else {
    intervalId = setInterval(stepForward, pace);
    playPauseBtn.textContent = 'Pause';
  }
  isPlaying = !isPlaying;
});


	// ——— INSPECT AGGREGATED VALUES ———

// 1) Build an array of { state, month, cases }
const aggTable = Object.entries(casesLookup).map(([key, value]) => {
  const [state, month] = key.split('_');
  return { State: state, Month: month, Cases: value };
})
// Sort so highest-case entries bubble to the top
.sort((a, b) => b.Cases - a.Cases);

// Print as a console table
console.log('=== State × Month Aggregated Cases ===');
console.table(aggTable);

// 2) Compute total cases per month (across all states)
const monthlyTotals = months.map(month => {
  const total = aggTable
    .filter(row => row.Month === month)
    .reduce((sum, row) => sum + row.Cases, 0);
  return { Month: month, TotalCases: total };
});

// Print monthly totals
console.log('=== Total Cases by Month ===');
console.table(monthlyTotals);

// ——— END INSPECTION ———


    // add everything
    addStateLayer();
    initSlider();
    addLegend();
    updateMap(firstMonth);

    // sync slider UI
    document.getElementById('dateSlider').value      = 0;
    document.getElementById('dateLabel').textContent = firstMonth;

    // autoplay
    let idx = 0;
    setInterval(() => {
      idx = (idx + 1) % months.length;
      document.getElementById('dateSlider').value      = idx;
      document.getElementById('dateLabel').textContent = months[idx];
      updateMap(months[idx]);
    }, 1000);
  });
</script>


</body>
</html>
